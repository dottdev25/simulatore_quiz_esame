<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulatore Esame Protetto</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        /* --- STILI (Invariati) --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .app-container { width: 100%; max-width: 800px; background-color: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; border-top: 8px solid #2c3e50; min-height: 400px; }
        header { background-color: #2c3e50; color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
        header h1 { font-size: 1.5rem; margin-bottom: 5px; }
        .badge { background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; }
        .screen { padding: 40px; text-align: center; display: none; animation: fadeIn 0.4s; }
        .screen.active { display: block; }
        .login-box { max-width: 400px; margin: 0 auto; text-align: left; }
        input.login-field { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; }
        .subject-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 30px; }
        .subject-card { background: #f8fafc; border: 2px solid #e2e8f0; padding: 20px; border-radius: 10px; cursor: pointer; transition: 0.2s; font-weight: bold; color: #2c3e50; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 10px; min-height: 110px; word-break: break-word; }
        .subject-card:hover { border-color: #3498db; background: #ebf5fb; transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .subject-icon { font-size: 2rem; }
        .progress-container { width: 100%; background-color: #e9ecef; height: 8px; }
        .progress-bar { height: 100%; background-color: #27ae60; width: 0%; transition: width 0.3s; }
        .question-meta { margin-bottom: 15px; font-size: 0.85rem; text-align: left; }
        .topic-badge { background-color: #e1f5fe; color: #0277bd; padding: 4px 8px; border-radius: 4px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; display: inline-block; margin-right: 10px; }
        .question-text { font-size: 1.35rem; color: #2c3e50; margin-bottom: 30px; line-height: 1.5; font-family: 'Merriweather', serif; text-align: left; }
        .question-id { color: #aaa; font-size: 0.7em; margin-right: 8px; vertical-align: middle; }
        .option-btn { width: 100%; text-align: left; padding: 15px 20px; background-color: white; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; color: #4a5568; cursor: pointer; margin-bottom: 10px; display: flex; align-items: flex-start; }
        .option-btn:hover:not(:disabled) { background-color: #f8fafc; border-color: #cbd5e1; }
        .option-letter { background-color: #f1f5f9; padding: 2px 8px; border-radius: 4px; border: 1px solid #cbd5e1; margin-right: 15px; font-weight: bold; min-width: 30px; text-align: center; }
        .option-btn.correct { background-color: #d1fae5 !important; border-color: #10b981 !important; color: #065f46 !important; }
        .option-btn.wrong { background-color: #fee2e2 !important; border-color: #ef4444 !important; color: #991b1b !important; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; background-color: #2c3e50; color: white; margin-top: 20px; }
        .btn:hover { background-color: #34495e; }
        .btn-secondary { background-color: #95a5a6; }
        .btn-outline { background: transparent; border: 2px solid #2c3e50; color: #2c3e50; }
        .keyboard-hint { font-size: 0.8rem; color: #999; margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px; text-align: center; }
        .key-badge { border: 1px solid #ccc; padding: 0px 5px; border-radius: 4px; font-family: monospace; font-size: 0.9em; background: #fff; }
        .error-msg { color: #c0392b; background: #fadbd8; padding: 10px; border-radius: 5px; margin-bottom: 15px; display: none; text-align: center; }
        .error-item { text-align: left; border-bottom: 1px solid #eee; padding: 15px 0; }
        .error-q { font-weight: bold; color: #2c3e50; margin-bottom: 5px; display: block;}
        .error-ans { font-size: 0.9rem; color: #c0392b; }
        .correct-ans { font-size: 0.9rem; color: #27ae60; font-weight: bold; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <div>
                <h1>Simulatore Esame</h1>
                <p style="font-size: 0.8rem; opacity: 0.8;">Area Riservata Studenti</p>
            </div>
            <div id="user-badge" class="badge" style="display:none;"></div>
        </header>

        <div id="login-screen" class="screen active">
            <h2>Accesso Sicuro</h2>
            <p style="color: #666; margin-bottom: 20px;">Inserisci email e PIN personale.</p>
            <div class="login-box">
                <div id="login-error" class="error-msg"></div>
                <label>Email Istituzionale</label>
                <input type="email" id="email" class="login-field" placeholder="nome.cognome@studenti.it">
                
                <label>PIN Personale (5 cifre)</label>
                <input type="password" id="pin" class="login-field" placeholder="es. 12345" maxlength="5">
                
                <button onclick="login()" class="btn" style="width: 100%;">Verifica e Accedi</button>
            </div>
        </div>

        <div id="dashboard-screen" class="screen">
            <h2>Scegli la Materia</h2>
            <div id="subject-container" class="subject-grid"></div>
            <button onclick="logout()" class="btn btn-secondary" style="margin-top: 40px;">Disconnetti</button>
        </div>

        <div id="quiz-screen" class="screen" style="text-align: left;">
            <div class="progress-container"><div id="progress-bar" class="progress-bar"></div></div>
            <div style="padding-top: 20px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; color:#7f8c8d; font-weight:bold;">
                    <span id="q-counter">Domanda 1</span>
                    <span>Punti: <span id="score">0</span></span>
                </div>
                <div id="question-meta" class="question-meta"></div>
                <div id="question-text" class="question-text"></div>
                <div id="options-container"></div>
                <div id="feedback" style="margin-top:20px; padding:15px; border-radius:8px; display:none;"></div>
                <div style="text-align: right;">
                    <button id="next-btn" onclick="nextQuestion()" class="btn" style="display:none;">Prossima &rarr;</button>
                    <button onclick="backToDashboard()" class="btn btn-secondary" style="margin-right: 10px;">Esci</button>
                </div>
                <div class="keyboard-hint">Navigazione: <span class="key-badge">1</span>-<span class="key-badge">9</span> scelte, <span class="key-badge">Invio</span> avanti</div>
            </div>
        </div>

        <div id="result-screen" class="screen">
            <h2>Esame Terminato</h2>
            <div style="font-size: 3rem; font-weight: bold; margin: 20px 0; color: #2c3e50;">
                <span id="final-score"></span>
            </div>
            <div id="final-msg" style="background:#f8fafc; padding:20px; border-radius:8px; margin-bottom:20px; font-style:italic;"></div>
            <button onclick="toggleErrors()" id="btn-errors" class="btn btn-outline" style="display:none; margin-bottom: 10px;">üîç Vedi Errori</button>
            <br>
            <button onclick="backToDashboard()" class="btn">Torna alla Dashboard</button>
            <div id="error-report" style="display: none; margin-top: 30px; border-top: 2px solid #eee;">
                <h3 style="margin-top: 20px; color: #c0392b;">Riepilogo Errori</h3>
                <div id="error-list"></div>
            </div>
        </div>
    </div>
    <script>
        const SESSION_DAYS = 7;
        const DATA_PATH = './data/';
        
        // --- CONFIGURAZIONE LOGGER ---
        let LOG_URL = null; 

        let sessionMasterKey = null;
        let examQuestions = [];
        let currentQIndex = 0;
        let score = 0;
        let wrongAnswers = []; 
        let currentExamTitle = ""; 
        let currentExamFile = ""; // --- NUOVO: Serve per salvare gli errori nel file giusto

        window.onload = checkSession;

        // --- GESTIONE TASTIERA ---
        document.addEventListener('keydown', function(event) {
            if(!document.getElementById('quiz-screen').classList.contains('active')) return;
            const key = event.key.toUpperCase();
            const nextBtn = document.getElementById('next-btn');
            
            if (key === 'ENTER') {
                if (nextBtn.style.display !== 'none') nextQuestion();
                return;
            }
            if (nextBtn.style.display !== 'none') return;

            let index = -1;
            if (key >= '1' && key <= '9') index = parseInt(key) - 1;
            else if (key.length === 1 && key >= 'A' && key <= 'Z') index = key.charCodeAt(0) - 65;

            const options = document.querySelectorAll('.option-btn');
            if (index >= 0 && index < options.length) options[index].click();
        });

        // --- LOGIN ---
        async function login() {
            const emailRaw = document.getElementById('email').value;
            const pin = document.getElementById('pin').value.trim();
            const errorEl = document.getElementById('login-error');

            if(!emailRaw || !pin) { showErr("Inserisci Email e PIN."); return; }
            if(pin.length < 5) { showErr("Il PIN deve essere di 5 cifre."); return; }

            try {
                showErr("Verifica...", "#e8f8f5", "#2c3e50");
                const emailClean = emailRaw.trim().toLowerCase();
                const emailHash = CryptoJS.SHA256(emailClean).toString();
                const response = await fetch(DATA_PATH + 'utenti.json?v=' + new Date().getTime());
                if(!response.ok) throw new Error("Database utenti non accessibile.");
                const db = await response.json();
                
                if(db.config && db.config.logUrl) LOG_URL = db.config.logUrl;

                const userRecord = db.users.find(u => u.id === emailHash);
                if(!userRecord) throw new Error("Email non trovata.");

                const bytes = CryptoJS.AES.decrypt(userRecord.vault, pin);
                let secretData;
                try {
                    const text = bytes.toString(CryptoJS.enc.Utf8);
                    if(!text) throw new Error(); 
                    secretData = JSON.parse(text);
                } catch(e) { throw new Error("PIN Errato."); }

                if(!secretData || secretData.check !== "OK") throw new Error("Errore integrit√† dati.");
                saveSession(emailClean, secretData.key, db.materie);

            } catch(e) {
                console.error(e);
                showErr("Accesso Negato: " + (e.message || "Credenziali non valide"));
            }
        }

        function showErr(msg, bg="#fadbd8", col="#c0392b") {
            const el = document.getElementById('login-error');
            el.innerText = msg; el.style.background=bg; el.style.color=col; el.style.display='block';
        }

        function saveSession(email, masterKey, materie) {
            const expire = new Date().getTime() + (SESSION_DAYS * 86400000);
            localStorage.setItem('exam_session_v4', JSON.stringify({ email, key: masterKey, expire, materie }));
            setTimeout(() => sendLog("LOGIN", "Accesso Effettuato"), 1000);
            checkSession();
        }

        function checkSession() {
            const data = JSON.parse(localStorage.getItem('exam_session_v4'));
            if(!data) { showScreen('login-screen'); return; }
            if(new Date().getTime() > data.expire) { logout(); return; }

            sessionMasterKey = data.key;
            document.getElementById('user-badge').innerText = data.email;
            document.getElementById('user-badge').style.display = 'block';
            generateSubjectButtons(data.materie);
            showScreen('dashboard-screen');
        }

        function generateSubjectButtons(list) {
            const container = document.getElementById('subject-container'); container.innerHTML = '';
            if (!list || list.length === 0) { container.innerHTML = '<p>Nessuna materia configurata.</p>'; return; }
            list.forEach(m => {
                const div = document.createElement('div'); div.className = 'subject-card';
                div.onclick = () => loadExam(m.file, m.titolo);
                div.innerHTML = `<span class="subject-icon">${m.icona||'üìù'}</span><span class="subject-title">${m.titolo}</span>`;
                container.appendChild(div);
            });
        }

        function logout() { localStorage.removeItem('exam_session_v4'); location.reload(); }

        // --- ESAME (CON LOGICA SCATOLA DEGLI ORRORI) ---
        async function loadExam(filename, title) {
            currentExamTitle = title || filename;
            currentExamFile = filename; // Salvo il nome del file per il local storage

            try {
                document.body.style.cursor = 'wait';
                const res = await fetch(`${DATA_PATH}${filename}.enc`);
                if(!res.ok) throw new Error(`File materia non trovato: ${filename}`);
                
                const decrypted = CryptoJS.AES.decrypt(await res.text(), sessionMasterKey).toString(CryptoJS.enc.Utf8);
                if(!decrypted) throw new Error("Impossibile decriptare.");
                
                let allQuestions = JSON.parse(decrypted);

                // --- NUOVO: Logica "Ripasso Errori" ---
                // 1. Recupero gli ID degli errori passati per questa materia
                const errorHistory = JSON.parse(localStorage.getItem('exam_errors_history') || '{}');
                const badQuestionIds = errorHistory[currentExamFile] || [];

                // 2. Separo le domande in "Prioritarie" (sbagliate prima) e "Nuove"
                let priorityQuestions = [];
                let otherQuestions = [];

                allQuestions.forEach(q => {
                    if (badQuestionIds.includes(q.id)) {
                        priorityQuestions.push(q);
                    } else {
                        otherQuestions.push(q);
                    }
                });

                // 3. Mischio entrambi i gruppi
                shuffleArray(priorityQuestions);
                shuffleArray(otherQuestions);

                // 4. Creo il mix finale: Prima le prioritarie, poi le altre fino a riempire 30
                examQuestions = [...priorityQuestions, ...otherQuestions].slice(0, 30);
                
                // Feedback visuale se stiamo facendo un ripasso
                if(priorityQuestions.length > 0) {
                    console.log(`Modalit√† Ripasso Attiva: ${priorityQuestions.length} domande prioritarie caricate.`);
                }
                // ----------------------------------------

                startQuiz();
            } catch(e) { alert("Errore caricamento: " + e.message); } 
            finally { document.body.style.cursor = 'default'; }
        }

        function startQuiz() {
            score = 0; currentQIndex = 0; wrongAnswers = [];
            showScreen('quiz-screen'); loadQuestion();
        }

        function loadQuestion() {
            const q = examQuestions[currentQIndex];
            document.getElementById('q-counter').innerText = `Domanda ${currentQIndex + 1} di ${examQuestions.length}`;
            document.getElementById('score').innerText = score;
            
            const topic = q.argomento || "Generale";
            document.getElementById('question-meta').innerHTML = `<span class="topic-badge">${topic}</span>`;
            document.getElementById('question-text').innerHTML = `<span class="question-id">#${q.id}</span>${q.domanda}`;
            document.getElementById('progress-bar').style.width = `${((currentQIndex)/examQuestions.length)*100}%`;

            const container = document.getElementById('options-container'); container.innerHTML = '';
            document.getElementById('feedback').style.display = 'none';
            document.getElementById('next-btn').style.display = 'none';

            // 1. Prendi le chiavi logiche (A, B, C...) e MESCOLALE
            let logicalKeys = Object.keys(q.opzioni);
            shuffleArray(logicalKeys); 

            // 2. Crea i bottoni
            logicalKeys.forEach((logicalKey, index) => {
                // Calcola l'etichetta VISIVA (sempre A, B, C, D in ordine dall'alto)
                const visualLabel = String.fromCharCode(65 + index);
                
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                
                // --- PUNTO CHIAVE: Salviamo la chiave vera (es. "B") in un attributo nascosto ---
                btn.dataset.logicalKey = logicalKey; 
                
                btn.innerHTML = `<span class="option-letter">${visualLabel}</span> ${q.opzioni[logicalKey]}`;
                
                // Passiamo la chiave logica al controllo
                btn.onclick = () => checkAnswer(logicalKey, q.risposta_corretta, btn);
                container.appendChild(btn);
            });
        }

        function checkAnswer(selectedLogicalKey, correctLogicalKey, btn) {
            // Disabilita tutti
            document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
            
            const fb = document.getElementById('feedback'); fb.style.display = 'block';
            const q = examQuestions[currentQIndex];

            if(selectedLogicalKey === correctLogicalKey) {
                // GIUSTO
                score++; document.getElementById('score').innerText = score;
                btn.classList.add('correct');
                fb.style.background = '#d1fae5';
                fb.innerHTML = `<strong style="color:#065f46">Risposta Esatta!</strong>`;
                
                updateErrorHistory(q.id, false); 

            } else {
                // SBAGLIATO
                btn.classList.add('wrong');
                
                // --- FIX BUG VISIVO (CON SHUFFLE) ---
                // Invece di cercare il testo, cerchiamo il bottone che ha l'attributo nascosto uguale alla risposta corretta
                const correctBtn = document.querySelector(`.option-btn[data-logical-key="${correctLogicalKey}"]`);
                if(correctBtn) correctBtn.classList.add('correct');

                const correctText = q.opzioni[correctLogicalKey];
                fb.style.background = '#fee2e2';
                
                // Mostriamo il testo della risposta corretta (pi√π utile della lettera, visto che sono mescolate)
                fb.innerHTML = `<strong style="color:#991b1b">Errato!</strong> La risposta giusta era: <br><em>${correctText}</em>`;
                
                wrongAnswers.push({ 
                    id: q.id, 
                    argomento: q.argomento || "Generale", 
                    domanda: q.domanda, 
                    rispostaData: q.opzioni[selectedLogicalKey], 
                    rispostaCorretta: q.opzioni[correctLogicalKey] 
                });
                
                updateErrorHistory(q.id, true);
            }
            document.getElementById('next-btn').style.display = 'inline-block';
        }

        // --- NUOVO: Funzione Helper per salvare/rimuovere errori dal LocalStorage ---
        function updateErrorHistory(questionId, isError) {
            let history = JSON.parse(localStorage.getItem('exam_errors_history') || '{}');
            if (!history[currentExamFile]) history[currentExamFile] = [];

            if (isError) {
                // Aggiungi se non c'√® gi√†
                if (!history[currentExamFile].includes(questionId)) {
                    history[currentExamFile].push(questionId);
                }
            } else {
                // Rimuovi se ho risposto giusto (cos√¨ smette di perseguitarmi)
                history[currentExamFile] = history[currentExamFile].filter(id => id !== questionId);
            }
            localStorage.setItem('exam_errors_history', JSON.stringify(history));
        }

        function nextQuestion() {
            currentQIndex++;
            if(currentQIndex < examQuestions.length) loadQuestion();
            else showResults();
        }

        function showResults() {
            showScreen('result-screen');
            document.getElementById('final-score').innerText = `${score} / ${examQuestions.length}`;
            const pct = (score / examQuestions.length) * 100;
            document.getElementById('final-msg').innerText = pct >= 90 ? "Eccellente! üèÜ" : pct >= 60 ? "Superato. üëç" : "Studiare di pi√π. üìâ";
            
            sendLog("QUIZ TERMINATO", `Punteggio: ${score}/${examQuestions.length} - Materia: ${currentExamTitle}`);

            const btnErr = document.getElementById('btn-errors');
            const report = document.getElementById('error-report');
            report.style.display = 'none';
            if(wrongAnswers.length > 0) {
                btnErr.style.display = 'inline-block';
                btnErr.innerText = `üîç Vedi ${wrongAnswers.length} Errori`;
            } else { btnErr.style.display = 'none'; }
        }

        // --- MODIFICATO: Report con Tasti "Gemini" e "Copia ID" ---
        function toggleErrors() {
            const rep = document.getElementById('error-report');
            const list = document.getElementById('error-list');
            if(rep.style.display === 'none') {
                rep.style.display = 'block'; list.innerHTML = '';
                
                wrongAnswers.forEach(item => {
                    // Prepara il testo per la ricerca (Toglie caratteri strani)
                    const searchQuery = encodeURIComponent("spiegazione " + item.domanda);
                    const googleUrl = `https://www.google.com/search?q=${searchQuery}`;
                    
                    // Prepara il testo per la segnalazione
                    const reportText = `[${currentExamTitle}] Errore ID #${item.id}: ${item.domanda.substring(0,30)}...`;

                    list.innerHTML += `
                        <div class="error-item">
                            <span class="error-q">
                                <small>[${item.argomento}] #${item.id}</small> 
                                ${item.domanda}
                            </span>
                            
                            <div class="error-ans">‚ùå Tua risposta: ${item.rispostaData}</div>
                            <div class="correct-ans">‚úÖ Corretta: ${item.rispostaCorretta}</div>
                            
                            <div style="margin-top:10px; display:flex; gap:10px;">
                                <a href="${googleUrl}" target="_blank" style="text-decoration:none;">
                                    <button class="btn btn-outline" style="font-size:0.8rem; padding:5px 10px;">
                                        üåê Cerca su Google
                                    </button>
                                </a>

                                <button onclick="copyToClipboard('${reportText}')" class="btn btn-outline" style="font-size:0.8rem; padding:5px 10px; border-color:#e67e22; color:#e67e22;">
                                    ‚ö†Ô∏è Segnala
                                </button>
                            </div>
                        </div>`;
                });
                window.scrollTo(0, document.body.scrollHeight);
            } else { rep.style.display = 'none'; }
        }

        // --- NUOVO: Funzione Copia incolla ---
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert("ID e dettagli copiati! Incolla il messaggio allo sviluppatore del software");
            });
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        function backToDashboard() { showScreen('dashboard-screen'); }
        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }

        // --- GESTIONE ID DISPOSITIVO PERSISTENTE ---
        function getOrCreateDeviceId() {
            // Cerca se esiste gi√† un ID salvato
            let deviceId = localStorage.getItem('exam_device_id');
            
            // Se non esiste (√® la prima volta che entra), crealo
            if (!deviceId) {
                // Genera un UUID casuale (es. "f47ac10b-58cc-4372-a567-0e02b2c3d479")
                deviceId = crypto.randomUUID(); 
                localStorage.setItem('exam_device_id', deviceId);
            }
            
            return deviceId;
        }

        function sendLog(action, details = "") {
            const sessionRaw = localStorage.getItem('exam_session_v4');
            if (!sessionRaw && action !== "LOGIN") return;
            
            let userEmail = "Sconosciuto";
            if (sessionRaw) {
                try {
                    const data = JSON.parse(sessionRaw);
                    userEmail = data.email;
                } catch(e) {}
            } else if (action === "LOGIN") {
                userEmail = document.getElementById('email')?.value || "Login Init";
            }

            if(!LOG_URL) return;

            // --- RECUPERA L'ID UNIVOCO ---
            const uniqueDeviceId = getOrCreateDeviceId();

            const payload = {
                email: userEmail,
                action: action,
                details: details,
                userAgent: navigator.userAgent,
                deviceId: uniqueDeviceId // <--- AGGIUNTO AL PACCHETTO
            };

            fetch(LOG_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            }).catch(e => console.error("Log fallito", e));
        }
    </script>
    </body>
</html>
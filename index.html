<script>
        const SESSION_DAYS = 7;
        const DATA_PATH = './data/';
        
        // --- CONFIGURAZIONE LOGGER ---
        let LOG_URL = null; 

        let sessionMasterKey = null;
        let examQuestions = [];
        let currentQIndex = 0;
        let score = 0;
        let wrongAnswers = []; 
        let currentExamTitle = ""; 
        let currentExamFile = ""; // --- NUOVO: Serve per salvare gli errori nel file giusto

        window.onload = checkSession;

        // --- GESTIONE TASTIERA ---
        document.addEventListener('keydown', function(event) {
            if(!document.getElementById('quiz-screen').classList.contains('active')) return;
            const key = event.key.toUpperCase();
            const nextBtn = document.getElementById('next-btn');
            
            if (key === 'ENTER') {
                if (nextBtn.style.display !== 'none') nextQuestion();
                return;
            }
            if (nextBtn.style.display !== 'none') return;

            let index = -1;
            if (key >= '1' && key <= '9') index = parseInt(key) - 1;
            else if (key.length === 1 && key >= 'A' && key <= 'Z') index = key.charCodeAt(0) - 65;

            const options = document.querySelectorAll('.option-btn');
            if (index >= 0 && index < options.length) options[index].click();
        });

        // --- LOGIN ---
        async function login() {
            const emailRaw = document.getElementById('email').value;
            const pin = document.getElementById('pin').value.trim();
            const errorEl = document.getElementById('login-error');

            if(!emailRaw || !pin) { showErr("Inserisci Email e PIN."); return; }
            if(pin.length < 5) { showErr("Il PIN deve essere di 5 cifre."); return; }

            try {
                showErr("Verifica...", "#e8f8f5", "#2c3e50");
                const emailClean = emailRaw.trim().toLowerCase();
                const emailHash = CryptoJS.SHA256(emailClean).toString();
                const response = await fetch(DATA_PATH + 'utenti.json?v=' + new Date().getTime());
                if(!response.ok) throw new Error("Database utenti non accessibile.");
                const db = await response.json();
                
                if(db.config && db.config.logUrl) LOG_URL = db.config.logUrl;

                const userRecord = db.users.find(u => u.id === emailHash);
                if(!userRecord) throw new Error("Email non trovata.");

                const bytes = CryptoJS.AES.decrypt(userRecord.vault, pin);
                let secretData;
                try {
                    const text = bytes.toString(CryptoJS.enc.Utf8);
                    if(!text) throw new Error(); 
                    secretData = JSON.parse(text);
                } catch(e) { throw new Error("PIN Errato."); }

                if(!secretData || secretData.check !== "OK") throw new Error("Errore integrit√† dati.");
                saveSession(emailClean, secretData.key, db.materie);

            } catch(e) {
                console.error(e);
                showErr("Accesso Negato: " + (e.message || "Credenziali non valide"));
            }
        }

        function showErr(msg, bg="#fadbd8", col="#c0392b") {
            const el = document.getElementById('login-error');
            el.innerText = msg; el.style.background=bg; el.style.color=col; el.style.display='block';
        }

        function saveSession(email, masterKey, materie) {
            const expire = new Date().getTime() + (SESSION_DAYS * 86400000);
            localStorage.setItem('exam_session_v4', JSON.stringify({ email, key: masterKey, expire, materie }));
            setTimeout(() => sendLog("LOGIN", "Accesso Effettuato"), 1000);
            checkSession();
        }

        function checkSession() {
            const data = JSON.parse(localStorage.getItem('exam_session_v4'));
            if(!data) { showScreen('login-screen'); return; }
            if(new Date().getTime() > data.expire) { logout(); return; }

            sessionMasterKey = data.key;
            document.getElementById('user-badge').innerText = data.email;
            document.getElementById('user-badge').style.display = 'block';
            document.getElementById('days-left').innerText = Math.ceil((data.expire - new Date().getTime()) / 86400000);
            generateSubjectButtons(data.materie);
            showScreen('dashboard-screen');
        }

        function generateSubjectButtons(list) {
            const container = document.getElementById('subject-container'); container.innerHTML = '';
            if (!list || list.length === 0) { container.innerHTML = '<p>Nessuna materia configurata.</p>'; return; }
            list.forEach(m => {
                const div = document.createElement('div'); div.className = 'subject-card';
                div.onclick = () => loadExam(m.file, m.titolo);
                div.innerHTML = `<span class="subject-icon">${m.icona||'üìù'}</span><span class="subject-title">${m.titolo}</span>`;
                container.appendChild(div);
            });
        }

        function logout() { localStorage.removeItem('exam_session_v4'); location.reload(); }

        // --- ESAME (CON LOGICA SCATOLA DEGLI ORRORI) ---
        async function loadExam(filename, title) {
            currentExamTitle = title || filename;
            currentExamFile = filename; // Salvo il nome del file per il local storage

            try {
                document.body.style.cursor = 'wait';
                const res = await fetch(`${DATA_PATH}${filename}.enc`);
                if(!res.ok) throw new Error(`File materia non trovato: ${filename}`);
                
                const decrypted = CryptoJS.AES.decrypt(await res.text(), sessionMasterKey).toString(CryptoJS.enc.Utf8);
                if(!decrypted) throw new Error("Impossibile decriptare.");
                
                let allQuestions = JSON.parse(decrypted);

                // --- NUOVO: Logica "Ripasso Errori" ---
                // 1. Recupero gli ID degli errori passati per questa materia
                const errorHistory = JSON.parse(localStorage.getItem('exam_errors_history') || '{}');
                const badQuestionIds = errorHistory[currentExamFile] || [];

                // 2. Separo le domande in "Prioritarie" (sbagliate prima) e "Nuove"
                let priorityQuestions = [];
                let otherQuestions = [];

                allQuestions.forEach(q => {
                    if (badQuestionIds.includes(q.id)) {
                        priorityQuestions.push(q);
                    } else {
                        otherQuestions.push(q);
                    }
                });

                // 3. Mischio entrambi i gruppi
                shuffleArray(priorityQuestions);
                shuffleArray(otherQuestions);

                // 4. Creo il mix finale: Prima le prioritarie, poi le altre fino a riempire 30
                examQuestions = [...priorityQuestions, ...otherQuestions].slice(0, 30);
                
                // Feedback visuale se stiamo facendo un ripasso
                if(priorityQuestions.length > 0) {
                    console.log(`Modalit√† Ripasso Attiva: ${priorityQuestions.length} domande prioritarie caricate.`);
                }
                // ----------------------------------------

                startQuiz();
            } catch(e) { alert("Errore caricamento: " + e.message); } 
            finally { document.body.style.cursor = 'default'; }
        }

        function startQuiz() {
            score = 0; currentQIndex = 0; wrongAnswers = [];
            showScreen('quiz-screen'); loadQuestion();
        }

        function loadQuestion() {
            const q = examQuestions[currentQIndex];
            document.getElementById('q-counter').innerText = `Domanda ${currentQIndex + 1} di ${examQuestions.length}`;
            document.getElementById('score').innerText = score;
            
            const topic = q.argomento || "Generale";
            document.getElementById('question-meta').innerHTML = `<span class="topic-badge">${topic}</span>`;
            document.getElementById('question-text').innerHTML = `<span class="question-id">#${q.id}</span>${q.domanda}`;
            document.getElementById('progress-bar').style.width = `${((currentQIndex)/examQuestions.length)*100}%`;

            const container = document.getElementById('options-container'); container.innerHTML = '';
            document.getElementById('feedback').style.display = 'none';
            document.getElementById('next-btn').style.display = 'none';

            let logicalKeys = Object.keys(q.opzioni);
            shuffleArray(logicalKeys); 

            logicalKeys.forEach((logicalKey, index) => {
                const visualLabel = String.fromCharCode(65 + index);
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerHTML = `<span class="option-letter">${visualLabel}</span> ${q.opzioni[logicalKey]}`;
                btn.onclick = () => checkAnswer(logicalKey, q.risposta_corretta, btn);
                container.appendChild(btn);
            });
        }

        function checkAnswer(selectedLogicalKey, correctLogicalKey, btn) {
            document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
            const fb = document.getElementById('feedback'); fb.style.display = 'block';
            
            const q = examQuestions[currentQIndex];

            if(selectedLogicalKey === correctLogicalKey) {
                score++; document.getElementById('score').innerText = score;
                btn.classList.add('correct');
                fb.style.background = '#d1fae5';
                fb.innerHTML = `<strong style="color:#065f46">Risposta Esatta!</strong>`;
                
                // --- NUOVO: Se rispondo correttamente, rimuovo l'errore dalla storia (se c'era) ---
                updateErrorHistory(q.id, false); 

            } else {
                btn.classList.add('wrong');
                const correctText = q.opzioni[correctLogicalKey];
                document.querySelectorAll('.option-btn').forEach(b => {
                    if(b.innerText.includes(correctText)) b.classList.add('correct');
                });
                fb.style.background = '#fee2e2';
                fb.innerHTML = `<strong style="color:#991b1b">Errato!</strong> Risposta: <strong>${correctText}</strong>`;
                
                wrongAnswers.push({ id: q.id, argomento: q.argomento || "Generale", domanda: q.domanda, rispostaData: q.opzioni[selectedLogicalKey], rispostaCorretta: q.opzioni[correctLogicalKey] });
                
                // --- NUOVO: Salvo l'errore nella storia ---
                updateErrorHistory(q.id, true);
            }
            document.getElementById('next-btn').style.display = 'inline-block';
        }

        // --- NUOVO: Funzione Helper per salvare/rimuovere errori dal LocalStorage ---
        function updateErrorHistory(questionId, isError) {
            let history = JSON.parse(localStorage.getItem('exam_errors_history') || '{}');
            if (!history[currentExamFile]) history[currentExamFile] = [];

            if (isError) {
                // Aggiungi se non c'√® gi√†
                if (!history[currentExamFile].includes(questionId)) {
                    history[currentExamFile].push(questionId);
                }
            } else {
                // Rimuovi se ho risposto giusto (cos√¨ smette di perseguitarmi)
                history[currentExamFile] = history[currentExamFile].filter(id => id !== questionId);
            }
            localStorage.setItem('exam_errors_history', JSON.stringify(history));
        }

        function nextQuestion() {
            currentQIndex++;
            if(currentQIndex < examQuestions.length) loadQuestion();
            else showResults();
        }

        function showResults() {
            showScreen('result-screen');
            document.getElementById('final-score').innerText = `${score} / ${examQuestions.length}`;
            const pct = (score / examQuestions.length) * 100;
            document.getElementById('final-msg').innerText = pct >= 90 ? "Eccellente! üèÜ" : pct >= 60 ? "Superato. üëç" : "Studiare di pi√π. üìâ";
            
            sendLog("QUIZ TERMINATO", `Punteggio: ${score}/${examQuestions.length} - Materia: ${currentExamTitle}`);

            const btnErr = document.getElementById('btn-errors');
            const report = document.getElementById('error-report');
            report.style.display = 'none';
            if(wrongAnswers.length > 0) {
                btnErr.style.display = 'inline-block';
                btnErr.innerText = `üîç Vedi ${wrongAnswers.length} Errori`;
            } else { btnErr.style.display = 'none'; }
        }

        // --- MODIFICATO: Report con Tasti "Gemini" e "Copia ID" ---
        function toggleErrors() {
            const rep = document.getElementById('error-report');
            const list = document.getElementById('error-list');
            if(rep.style.display === 'none') {
                rep.style.display = 'block'; list.innerHTML = '';
                
                wrongAnswers.forEach(item => {
                    // Prepara il testo per la ricerca (Toglie caratteri strani)
                    const searchQuery = encodeURIComponent("spiegazione " + item.domanda);
                    const googleUrl = `https://www.google.com/search?q=${searchQuery}`;
                    
                    // Prepara il testo per la segnalazione
                    const reportText = `[${currentExamTitle}] Errore ID #${item.id}: ${item.domanda.substring(0,30)}...`;

                    list.innerHTML += `
                        <div class="error-item">
                            <span class="error-q">
                                <small>[${item.argomento}] #${item.id}</small> 
                                ${item.domanda}
                            </span>
                            
                            <div class="error-ans">‚ùå Tua risposta: ${item.rispostaData}</div>
                            <div class="correct-ans">‚úÖ Corretta: ${item.rispostaCorretta}</div>
                            
                            <div style="margin-top:10px; display:flex; gap:10px;">
                                <a href="${googleUrl}" target="_blank" style="text-decoration:none;">
                                    <button class="btn btn-outline" style="font-size:0.8rem; padding:5px 10px;">
                                        ü§ñ Chiedi all'IA
                                    </button>
                                </a>

                                <button onclick="copyToClipboard('${reportText}')" class="btn btn-outline" style="font-size:0.8rem; padding:5px 10px; border-color:#e67e22; color:#e67e22;">
                                    ‚ö†Ô∏è Segnala
                                </button>
                            </div>
                        </div>`;
                });
                window.scrollTo(0, document.body.scrollHeight);
            } else { rep.style.display = 'none'; }
        }

        // --- NUOVO: Funzione Copia incolla ---
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert("ID e dettagli copiati! Incolla il messaggio al professore.");
            });
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        function backToDashboard() { showScreen('dashboard-screen'); }
        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }

        function sendLog(action, details = "") {
            const sessionRaw = localStorage.getItem('exam_session_v4');
            if (!sessionRaw && action !== "LOGIN") return;
            
            let userEmail = "Sconosciuto";
            if (sessionRaw) {
                try {
                    const data = JSON.parse(sessionRaw);
                    userEmail = data.email;
                } catch(e) {}
            } else if (action === "LOGIN") {
                userEmail = document.getElementById('email')?.value || "Login Init";
            }

            if(!LOG_URL) return;

            const payload = {
                email: userEmail,
                action: action,
                details: details,
                userAgent: navigator.userAgent
            };

            fetch(LOG_URL, {
                method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            }).catch(e => console.error("Log fallito", e));
        }
    </script>
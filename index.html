<!DOCTYPE html>
<html lang="it">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Simulatore Esame Protetto</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
        <style>
            /* --- STILI BASE --- */
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            body {
                font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
                background-color: #f0f2f5;
                color: #333;
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 100vh;
                padding: 20px;
            }

            .app-container {
                width: 100%;
                max-width: 800px;
                background-color: white;
                border-radius: 12px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
                overflow: hidden;
                border-top: 8px solid #2c3e50;
                min-height: 400px;
            }

            header {
                background-color: #2c3e50;
                color: white;
                padding: 20px 30px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            header h1 {
                font-size: 1.5rem;
                margin-bottom: 5px;
            }
            .badge {
                background: rgba(255, 255, 255, 0.2);
                padding: 5px 10px;
                border-radius: 20px;
                font-size: 0.8rem;
            }

            .screen {
                padding: 40px;
                text-align: center;
                display: none;
                animation: fadeIn 0.4s;
            }
            .screen.active {
                display: block;
            }

            /* LOGIN */
            .login-box {
                max-width: 400px;
                margin: 0 auto;
                text-align: left;
            }
            input.login-field {
                width: 100%;
                padding: 15px;
                margin: 10px 0;
                border: 2px solid #e2e8f0;
                border-radius: 8px;
                font-size: 1rem;
            }

            /* DASHBOARD DINAMICA */
            .subject-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
                margin-top: 30px;
            }

            .subject-card {
                background: #f8fafc;
                border: 2px solid #e2e8f0;
                padding: 20px;
                border-radius: 10px;
                cursor: pointer;
                transition: 0.2s;
                font-weight: bold;
                color: #2c3e50;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-direction: column;
                gap: 10px;
                /* Modifica per nomi lunghi: altezza minima invece che fissa */
                min-height: 110px;
                word-break: break-word; /* Evita che parole lunghissime escano fuori */
            }

            .subject-card:hover {
                border-color: #3498db;
                background: #ebf5fb;
                transform: translateY(-2px);
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            }
            .subject-icon {
                font-size: 2rem;
            }
            .subject-title {
                font-size: 1.1rem;
                line-height: 1.3;
            }

            /* QUIZ */
            .progress-container {
                width: 100%;
                background-color: #e9ecef;
                height: 8px;
            }
            .progress-bar {
                height: 100%;
                background-color: #27ae60;
                width: 0%;
                transition: width 0.3s;
            }
            .question-text {
                font-size: 1.35rem;
                color: #2c3e50;
                margin-bottom: 30px;
                line-height: 1.5;
                font-family: 'Merriweather', serif;
                text-align: left;
            }
            .option-btn {
                width: 100%;
                text-align: left;
                padding: 15px 20px;
                background-color: white;
                border: 2px solid #e2e8f0;
                border-radius: 8px;
                font-size: 1rem;
                color: #4a5568;
                cursor: pointer;
                margin-bottom: 10px;
                display: flex;
                align-items: flex-start;
            }
            .option-btn:hover:not(:disabled) {
                background-color: #f8fafc;
                border-color: #cbd5e1;
            }
            .option-letter {
                background-color: #f1f5f9;
                padding: 2px 8px;
                border-radius: 4px;
                border: 1px solid #cbd5e1;
                margin-right: 15px;
                font-weight: bold;
                min-width: 30px;
                text-align: center;
            }

            .option-btn.correct {
                background-color: #d1fae5 !important;
                border-color: #10b981 !important;
                color: #065f46 !important;
            }
            .option-btn.wrong {
                background-color: #fee2e2 !important;
                border-color: #ef4444 !important;
                color: #991b1b !important;
            }

            .btn {
                padding: 12px 25px;
                border: none;
                border-radius: 8px;
                font-size: 1rem;
                font-weight: bold;
                cursor: pointer;
                background-color: #2c3e50;
                color: white;
                margin-top: 20px;
            }
            .btn:hover {
                background-color: #34495e;
            }
            .btn-secondary {
                background-color: #95a5a6;
            }

            .error-msg {
                color: #c0392b;
                background: #fadbd8;
                padding: 10px;
                border-radius: 5px;
                margin-bottom: 15px;
                display: none;
                text-align: center;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }
        </style>
    </head>
    <body>
        <div class="app-container">
            <header>
                <div>
                    <h1>Simulatore Esame</h1>
                    <p style="font-size: 0.8rem; opacity: 0.8">
                        Area Riservata Studenti
                    </p>
                </div>
                <div id="user-badge" class="badge" style="display: none"></div>
            </header>

            <div id="login-screen" class="screen active">
                <h2>Accedi al Portale</h2>
                <p style="color: #666; margin-bottom: 20px">
                    Inserisci email istituzionale e codice accesso.
                </p>

                <div class="login-box">
                    <div id="login-error" class="error-msg"></div>

                    <label>Email</label>
                    <input
                        type="email"
                        id="email"
                        class="login-field"
                        placeholder="nome.cognome@studenti.it"
                    />

                    <label>Password</label>
                    <input
                        type="password"
                        id="password"
                        class="login-field"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    />

                    <button onclick="login()" class="btn" style="width: 100%">
                        Verifica e Accedi
                    </button>
                </div>
            </div>

            <div id="dashboard-screen" class="screen">
                <h2>Scegli la Materia</h2>
                <p>
                    Sessione valida per altri
                    <strong id="days-left"></strong> giorni.
                </p>

                <div id="subject-container" class="subject-grid"></div>

                <button
                    onclick="logout()"
                    class="btn btn-secondary"
                    style="margin-top: 40px"
                >
                    Disconnetti
                </button>
            </div>

            <div id="quiz-screen" class="screen" style="text-align: left">
                <div class="progress-container">
                    <div id="progress-bar" class="progress-bar"></div>
                </div>
                <div style="padding-top: 20px">
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 10px;
                            color: #7f8c8d;
                            font-weight: bold;
                        "
                    >
                        <span id="q-counter">Domanda 1</span>
                        <span>Punti: <span id="score">0</span></span>
                    </div>

                    <h3 id="question-text" class="question-text"></h3>
                    <div id="options-container"></div>

                    <div
                        id="feedback"
                        style="
                            margin-top: 20px;
                            padding: 15px;
                            border-radius: 8px;
                            display: none;
                        "
                    ></div>

                    <div style="text-align: right">
                        <button
                            id="next-btn"
                            onclick="nextQuestion()"
                            class="btn"
                            style="display: none"
                        >
                            Prossima &rarr;
                        </button>
                        <button
                            onclick="backToDashboard()"
                            class="btn btn-secondary"
                            style="margin-right: 10px"
                        >
                            Esci
                        </button>
                    </div>
                </div>
            </div>

            <div id="result-screen" class="screen">
                <h2>Esame Terminato</h2>
                <div
                    style="
                        font-size: 3rem;
                        font-weight: bold;
                        margin: 20px 0;
                        color: #2c3e50;
                    "
                >
                    <span id="final-score"></span>
                </div>
                <div
                    id="final-msg"
                    style="
                        background: #f8fafc;
                        padding: 20px;
                        border-radius: 8px;
                        margin-bottom: 20px;
                        font-style: italic;
                    "
                ></div>
                <button onclick="backToDashboard()" class="btn">
                    Torna alla Dashboard
                </button>
            </div>
        </div>

        <script>
            // --- CONFIGURAZIONE ---
            const SESSION_DAYS = 7;
            const DATA_PATH = './data/';

            // --- STATO ---
            let sessionKey = null;
            let examQuestions = [];
            let currentQIndex = 0;
            let score = 0;

            window.onload = checkSession;

            // --- GESTIONE LOGIN & SESSIONE ---
            async function login() {
                const email = document
                    .getElementById('email')
                    .value.trim()
                    .toLowerCase();
                const pass = document.getElementById('password').value;
                const errorEl = document.getElementById('login-error');

                if (!email || !pass) {
                    errorEl.innerText = 'Inserisci tutti i dati.';
                    errorEl.style.display = 'block';
                    return;
                }

                try {
                    errorEl.innerText = 'Decodifica in corso...';
                    errorEl.style.display = 'block';
                    errorEl.style.background = '#e8f8f5';
                    errorEl.style.color = '#2c3e50';

                    // 1. Scarica Utenti Criptati
                    const response = await fetch(
                        DATA_PATH + 'utenti.enc?v=' + new Date().getTime()
                    );
                    if (!response.ok)
                        throw new Error('File di configurazione non trovato.');

                    const encryptedText = await response.text();

                    // 2. Decripta
                    const decryptedBytes = CryptoJS.AES.decrypt(
                        encryptedText,
                        pass
                    );
                    const decryptedString = decryptedBytes.toString(
                        CryptoJS.enc.Utf8
                    );

                    if (!decryptedString) throw new Error('Password errata.');

                    // 3. Analizza i dati
                    const dataObj = JSON.parse(decryptedString);

                    // Compatibilit√†: supporta array semplice o oggetto completo
                    const emails = Array.isArray(dataObj)
                        ? dataObj
                        : dataObj.emails || [];
                    const materie = dataObj.materie || [];

                    if (emails.includes(email)) {
                        // Login Successo: salva sessione e lista materie
                        saveSession(email, pass, materie);
                    } else {
                        throw new Error('Email non autorizzata.');
                    }
                } catch (e) {
                    console.error(e);
                    errorEl.innerText =
                        'Errore: ' + (e.message || 'Credenziali non valide');
                    errorEl.style.background = '#fadbd8';
                    errorEl.style.color = '#c0392b';
                }
            }

            function saveSession(email, key, materie) {
                const now = new Date();
                const expire =
                    now.getTime() + SESSION_DAYS * 24 * 60 * 60 * 1000;

                const data = { email, key, expire, materie };

                localStorage.setItem('exam_session_v2', JSON.stringify(data));
                checkSession();
            }

            function checkSession() {
                const data = JSON.parse(
                    localStorage.getItem('exam_session_v2')
                );
                if (!data) {
                    showScreen('login-screen');
                    return;
                }

                if (new Date().getTime() > data.expire) {
                    logout();
                    return;
                }

                // Sessione valida
                sessionKey = data.key;
                document.getElementById('user-badge').innerText = data.email;
                document.getElementById('user-badge').style.display = 'block';
                document.getElementById('days-left').innerText = Math.ceil(
                    (data.expire - new Date().getTime()) / 86400000
                );

                // Genera bottoni dinamicamente
                generateSubjectButtons(data.materie);

                showScreen('dashboard-screen');
            }

            function generateSubjectButtons(materieList) {
                const container = document.getElementById('subject-container');
                container.innerHTML = '';

                if (!materieList || materieList.length === 0) {
                    container.innerHTML =
                        '<p style="grid-column:1/-1; color:#777;">Nessuna materia configurata.</p>';
                    return;
                }

                materieList.forEach((m) => {
                    const div = document.createElement('div');
                    div.className = 'subject-card';
                    div.onclick = () => loadExam(m.file); // m.file sar√† es: 'Anatomia_Tessuto_Osseo'

                    const icon = m.icona || 'üìù';
                    div.innerHTML = `<span class="subject-icon">${icon}</span><span class="subject-title">${m.titolo}</span>`;

                    container.appendChild(div);
                });
            }

            function logout() {
                localStorage.removeItem('exam_session_v2');
                location.reload();
            }

            // --- GESTIONE ESAME ---
            async function loadExam(filename) {
                try {
                    document.body.style.cursor = 'wait';
                    // Scarica file specifico .enc
                    const res = await fetch(`${DATA_PATH}${filename}.enc`);
                    if (!res.ok)
                        throw new Error(`File ${filename}.enc non trovato.`);

                    const encText = await res.text();

                    // Decripta con la password di sessione
                    const bytes = CryptoJS.AES.decrypt(encText, sessionKey);
                    const jsonStr = bytes.toString(CryptoJS.enc.Utf8);

                    if (!jsonStr)
                        throw new Error('Errore decrittazione file materia.');

                    let questions = JSON.parse(jsonStr);
                    // Mischia e prendi 30 domande
                    examQuestions = questions
                        .sort(() => Math.random() - 0.5)
                        .slice(0, 30);

                    startQuiz();
                } catch (e) {
                    alert('Errore caricamento: ' + e.message);
                } finally {
                    document.body.style.cursor = 'default';
                }
            }

            // --- UI QUIZ ---
            function startQuiz() {
                score = 0;
                currentQIndex = 0;
                showScreen('quiz-screen');
                loadQuestion();
            }

            function loadQuestion() {
                const q = examQuestions[currentQIndex];
                document.getElementById('q-counter').innerText = `Domanda ${
                    currentQIndex + 1
                } di ${examQuestions.length}`;
                document.getElementById('score').innerText = score;
                document.getElementById('question-text').innerText = q.domanda;

                const pct = (currentQIndex / examQuestions.length) * 100;
                document.getElementById('progress-bar').style.width = `${pct}%`;

                const container = document.getElementById('options-container');
                container.innerHTML = '';
                document.getElementById('feedback').style.display = 'none';
                document.getElementById('next-btn').style.display = 'none';

                Object.keys(q.opzioni)
                    .sort()
                    .forEach((l) => {
                        const btn = document.createElement('button');
                        btn.className = 'option-btn';
                        btn.innerHTML = `<span class="option-letter">${l}</span> ${q.opzioni[l]}`;
                        btn.onclick = () =>
                            checkAnswer(l, q.risposta_corretta, btn);
                        container.appendChild(btn);
                    });
            }

            function checkAnswer(selected, correct, btn) {
                document
                    .querySelectorAll('.option-btn')
                    .forEach((b) => (b.disabled = true));
                const fb = document.getElementById('feedback');
                fb.style.display = 'block';

                if (selected === correct) {
                    score++;
                    document.getElementById('score').innerText = score;
                    btn.classList.add('correct');
                    fb.style.background = '#d1fae5';
                    fb.innerHTML = `<strong style="color:#065f46">Risposta Esatta!</strong>`;
                } else {
                    btn.classList.add('wrong');
                    document.querySelectorAll('.option-btn').forEach((b) => {
                        if (
                            b.innerHTML.includes(
                                `<span class="option-letter">${correct}</span>`
                            )
                        )
                            b.classList.add('correct');
                    });
                    fb.style.background = '#fee2e2';
                    fb.innerHTML = `<strong style="color:#991b1b">Errato!</strong> Risposta: <strong>${correct}</strong>`;
                }
                document.getElementById('next-btn').style.display =
                    'inline-block';
            }

            function nextQuestion() {
                currentQIndex++;
                if (currentQIndex < examQuestions.length) loadQuestion();
                else showResults();
            }

            function showResults() {
                showScreen('result-screen');
                document.getElementById(
                    'final-score'
                ).innerText = `${score} / ${examQuestions.length}`;
                const pct = (score / examQuestions.length) * 100;
                let msg =
                    pct >= 90
                        ? 'Risultato Eccellente! üèÜ'
                        : pct >= 60
                        ? 'Esame Superato. üëç'
                        : 'Bisogna studiare di pi√π. üìâ';
                document.getElementById('final-msg').innerText = msg;
            }

            function backToDashboard() {
                showScreen('dashboard-screen');
            }

            function showScreen(id) {
                document
                    .querySelectorAll('.screen')
                    .forEach((s) => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            }
        </script>
    </body>
</html>
